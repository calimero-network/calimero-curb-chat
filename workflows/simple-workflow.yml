description: Simple bootstrap workflow for Calimero Chat application
name: Calimero Chat Bootstrap Workflow

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: calimero-node

steps:
  # Step 1: Install the application on the first node
  # This captures the application ID for use in subsequent steps
  - name: Install Application on Node 1
    type: install_application
    node: calimero-node-1
    path: "../logic/res/curb.wasm"
    dev: true
    outputs:
      app_id: applicationId

  # Step 2: Create a context using the installed application
  # Uses the captured application ID from step 1
  - name: Create Context on Node 1
    type: create_context
    node: calimero-node-1
    application_id: '{{app_id}}'
    params: '{"name": "CurbTest","is_dm": false, "default_channels": [{"name": "general"}],"created_at": 1751952997, "owner_username": "Bob"}'
    outputs:
          context_id: contextId
          member_public_key: memberPublicKey

  # Step 3: Generate an identity on the second node
  # This captures the public key for use in invitation and joining
  - name: Create Identity on Node 2
    type: create_identity
    node: calimero-node-2
    outputs:
      public_key: publicKey

  # Step 4: Wait for identity creation to complete
  - name: Wait for Identity Creation
    type: wait
    seconds: 5

  # Step 5: Invite the second node to join the context
  # Uses captured values: context ID, member public key, and identity public key
  - name: Invite Node 2 from Node 1
    type: invite_identity
    node: calimero-node-1
    context_id: '{{context_id}}'
    grantee_id: '{{public_key}}'
    granter_id: '{{member_public_key}}'
    capability: member
    outputs:
      invitation: invitation

  # Step 6: Join the context from the second node
  # Uses captured values: context ID, invitee identity, and invitation data
  - name: Join Context from Node 2
    type: join_context
    node: calimero-node-2
    context_id: '{{context_id}}'
    invitee_id: '{{public_key}}'
    invitation: '{{invitation}}'

  - name: Wait for context sync
    type: wait
    seconds: 3

  # Step 7: Join chat from Node 2
  - name: Join Chat from Node 2
    type: call
    node: calimero-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: join_chat
    args:
      username: Alice

  # Step 8: Wait for join operation to complete
  - name: Wait for Join Operation
    type: wait
    seconds: 3

  # Step 9: Send message from Node 1 to general channel
  - name: Send Message from Node 1 - Hello Node1
    type: call
    node: calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: send_message
    args:
      group:
        name: general
      message: hello node1
      parent_message: null
      mentions: []
      mentions_usernames: []
      timestamp: 1751652997
      sender_username: Bob

  # Step 10: Wait for message to be sent
  - name: Wait for Message Send
    type: wait
    seconds: 2

  # Step 11: Send message from Node 2 to general channel
  - name: Send Message from Node 2 - Hello Node2
    type: call
    node: calimero-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: send_message
    args:
      group:
        name: general
      message: hello node2
      parent_message: null
      mentions: []
      mentions_usernames: []
      timestamp: 1751653000
      sender_username: Alice

  # Step 12: Wait for message to be sent
  - name: Wait for Second Message Send
    type: wait
    seconds: 2

  # Step 13: Get messages from Node 1
  - name: Get Messages from Node 1
    type: call
    node: calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: get_messages
    args:
      group:
        name: general
      parent_message: null
      limit: 10
      offset: 0

  # Step 14: Get messages from Node 2
  - name: Get Messages from Node 2
    type: call
    node: calimero-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: get_messages
    args:
      group:
        name: general
      parent_message: null
      limit: 10
      offset: 0

# Configuration options
stop_all_nodes: true
restart: false          # Don't restart nodes at the beginning of workflow
wait_timeout: 60