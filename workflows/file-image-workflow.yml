name: Curb File & Image Message Workflow
description: Send Curb chat messages that include blob-backed file and image attachments

auth_service: true

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: calimero-node

steps:
  - name: Install Curb Application on Node 1
    type: install_application
    node: calimero-node-1
    path: "../logic/res/curb-blobs-1.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Curb Context on Node 1
    type: create_context
    node: calimero-node-1
    application_id: "{{app_id}}"
    params: '{"name": "CurbBlobTest","is_dm": false,"default_channels": [{"name": "general"}],"created_at": 1751952997,"owner_username": "Bob"}'
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  - name: Create Identity on Node 2
    type: create_identity
    node: calimero-node-2
    outputs:
      public_key: publicKey

  - name: Wait for Identity Setup
    type: wait
    seconds: 8

  - name: Invite Node 2 from Node 1
    type: invite_identity
    node: calimero-node-1
    context_id: "{{context_id}}"
    grantee_id: "{{public_key}}"
    granter_id: "{{member_public_key}}"
    capability: member
    outputs:
      invitation: invitation

  - name: Join Context from Node 2
    type: join_context
    node: calimero-node-2
    context_id: "{{context_id}}"
    invitee_id: "{{public_key}}"
    invitation: "{{invitation}}"

  - name: Wait for Context Sync
    type: wait
    seconds: 6

  - name: Join Chat from Node 2
    type: call
    node: calimero-node-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key}}"
    method: join_chat
    args:
      username: Alice
      is_dm: false
    timeout: 60

  - name: Wait for Join Completion
    type: wait
    seconds: 6

  - name: Upload Screenshot Image Blob
    type: upload_blob
    node: calimero-node-1
    file_path: blob-test-file/screenshot.png
    context_id: "{{context_id}}"
    outputs:
      png_blob_id: blob_id
      png_blob_size: size
    timeout: 60

  - name: Upload Sample PDF Blob (Node 2)
    type: upload_blob
    node: calimero-node-2
    file_path: blob-test-file/sample.pdf
    context_id: "{{context_id}}"
    outputs:
      pdf_blob_id_node2: blob_id
      pdf_blob_size_node2: size
    timeout: 60

  - name: Wait for Blob Announcements
    type: wait
    seconds: 6

  - name: Send Attachment Message from Node 1
    type: call
    node: calimero-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: send_message
    args:
      group:
        name: general
      message: "hello from node1 with attachments"
      parent_message: null
      mentions: []
      mentions_usernames: []
      timestamp: 1751953999
      sender_username: Bob
      images:
        - name: screenshot.png
          blob_id_str: "{{png_blob_id}}"
          size: "{{png_blob_size}}"
          mime_type: image/png
    timeout: 90

  - name: Wait for Message Propagation
    type: wait
    seconds: 8

  - name: Send Attachment Message from Node 2
    type: call
    node: calimero-node-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key}}"
    method: send_message
    args:
      group:
        name: general
      message: "hello from node2 with file"
      parent_message: null
      mentions: []
      mentions_usernames: []
      timestamp: 1751954099
      sender_username: Alice
      files:
        - name: project-proposal.pdf
          blob_id_str: "{{pdf_blob_id_node2}}"
          size: "{{pdf_blob_size_node2}}"
          mime_type: application/pdf
    timeout: 90

  - name: Wait for Second Message Propagation
    type: wait
    seconds: 6

  - name: Fetch Messages from Node 1
    type: call
    node: calimero-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_messages
    args:
      group:
        name: general
      parent_message: null
      limit: 5
      offset: 0
    outputs:
      received_messages_node1: result
    timeout: 90

  - name: Fetch Messages from Node 2
    type: call
    node: calimero-node-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key}}"
    method: get_messages
    args:
      group:
        name: general
      parent_message: null
      limit: 5
      offset: 0
    outputs:
      received_messages_node2: result
    timeout: 90

  - name: Assert Message Contains Attachments
    type: assert
    statements:
      - "contains({{received_messages_node1}}, 'screenshot.png')"
      - "contains({{received_messages_node2}}, 'project-proposal.pdf')"
    timeout: 60

# Configuration
stop_all_nodes: false
restart: false
wait_timeout: 120

